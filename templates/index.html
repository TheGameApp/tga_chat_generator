<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat 9:16 solo mensajes</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>

<body>
    <div class="chat-container">
        <!-- Instagram Story Reply Header -->
        <div class="story-reply-header">
            <img src="https://i.pravatar.cc/150?img=1" alt="User" class="story-reply-avatar">
            <div class="story-reply-info">
                <h3 class="story-reply-username">maria_fernanda</h3>
                <p class="story-reply-status">Respondiendo a tu historia</p>
            </div>
            <button class="story-reply-close">×</button>
        </div>

        <div class="messages-container" id="chat">
            <!-- Messages will be inserted here by JavaScript -->
        </div>
    </div>

    <script>
        // Variables globales
        const data = { slides: [] };
        const container = document.getElementById("chat");
        let messageIndex = 0;

        
        // Función para cargar el JSON externo
        async function loadConversation() {
            try {
                console.log('Intentando cargar la conversación...');
                const response = await fetch('/static/js/conversation.json', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('Estado de la respuesta:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error en la respuesta:', errorText);
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
                
                const responseData = await response.json();
                console.log('Datos cargados:', responseData);
                
                // Verificar la estructura de los datos
                if (!responseData.slides || !Array.isArray(responseData.slides)) {
                    throw new Error('Formato de datos inválido: se esperaba un array en la propiedad "slides"');
                }
                
                // Asignar los datos y comenzar la conversación
                data.slides = responseData.slides;
                messageIndex = 0; // Reiniciar el índice
                addMessage();
                
            } catch (error) {
                console.error('Error al cargar la conversación:', error);
                // Mostrar un mensaje de error detallado en el chat
                const errorContainer = document.getElementById("chat");
                const errorMsg = document.createElement("div");
                errorMsg.className = "message chico";
                errorMsg.textContent = `Error: ${error.message || 'No se pudo cargar la conversación'}`;
                errorContainer.appendChild(errorMsg);
                
                // Mostrar mensaje de error en la consola del navegador
                console.error('Detalles del error:', {
                    error: error.toString(),
                    stack: error.stack,
                    data: data
                });
            }
        }

        function addMessage() {
            if (messageIndex >= data.slides.length) return;

            const slide = data.slides[messageIndex];

            if (slide.tipo_slide === "chat") {
                // Create message container
                const messageContainer = document.createElement("div");
                messageContainer.classList.add("message");

                // Add story preview for first message
                if (slide.isStoryReply) {
                    messageContainer.classList.add("story-reply-message");

                    // Create story preview
                    const storyPreview = document.createElement("div");
                    storyPreview.className = "story-preview";
                    storyPreview.innerHTML = `
                        <div class="story-preview-container">
                            <div class="story-preview-content">
                                <div class="story-preview-label">You replied to their story</div>
                                <div class="story-preview-image">
                                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80" alt="Story preview">
                                </div>
                            </div>
                        </div>
                        <div class="story-sidebar"></div>
                    `;
                    container.appendChild(storyPreview);
                }

                // Add role class
                if (slide.rol === "Chico") messageContainer.classList.add("chico");
                if (slide.rol === "Chica") messageContainer.classList.add("chica");

                // Set message content
                messageContainer.textContent = slide.mensaje;

                // Add typing indicator for the girl's messages (except first one)
                if (messageIndex > 0 && slide.rol === "Chica") {
                    const typing = document.createElement("div");
                    typing.className = "typing-indicator";
                    typing.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    container.appendChild(typing);

                    // Se ha comentado el timeout para eliminar el delay
                    // setTimeout(() => {
                        typing.remove();
                        container.appendChild(messageContainer);
                        container.scrollTop = container.scrollHeight;
                    // }, 1000);
                } else {
                    container.appendChild(messageContainer);
                    container.scrollTop = container.scrollHeight;
                }
            }

            messageIndex++;

            // Se ha comentado el timeout para mostrar los mensajes sin delay
            if (messageIndex < data.slides.length) {
                // setTimeout(addMessage, messageIndex === 1 ? 1500 : 2000);
                addMessage();
            }
        }

        // Función para verificar si todos los mensajes están visibles
        function allMessagesVisible() {
            const messages = container.querySelectorAll('.message');
            return messages.length > 0 && 
                   Array.from(messages).every(msg => {
                       const rect = msg.getBoundingClientRect();
                       return rect.height > 0 && rect.width > 0;
                   });
        }

        // Función para esperar a que todos los mensajes estén visibles
        async function waitForAllMessages() {
            return new Promise((resolve) => {
                const check = () => {
                    if (allMessagesVisible()) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // Función para iniciar la conversación
        async function initConversation() {
            try {
                await loadConversation();
                
                // Esperar a que todos los mensajes estén visibles
                await waitForAllMessages();
                
                // Pequeña pausa adicional para asegurar que todo esté renderizado
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('Iniciando captura automática...');
                const result = await captureConversation(false);
                console.log('Captura automática completada:', result);
                
            } catch (error) {
                console.error('Error al iniciar la conversación:', error);
            }
        }

        // Iniciar todo cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initConversation);

        // Close button functionality
        document.querySelector('.story-reply-close').addEventListener('click', function () {
            // Add close animation or navigation here
            console.log('Close button clicked');
        });
    </script>
</body>

</html>